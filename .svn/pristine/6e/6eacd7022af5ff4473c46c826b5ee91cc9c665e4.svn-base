// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace BlazorServerApp.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using BlazorServerApp;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using BlazorServerApp.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Blazored.LocalStorage;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using BlazorServerApp.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.SearchProductScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.ViewProductScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.CartScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.LoginScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.CoreBusiness.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 19 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using BlazorServerApp.Controls;

#line default
#line hidden
#nullable disable
#nullable restore
#line 21 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Radzen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Radzen.Blazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 23 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.RegisterScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 24 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.FavProductScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 26 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using System.IO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 27 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using System.Configuration;

#line default
#line hidden
#nullable disable
#nullable restore
#line 29 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.Extensions.Configuration;

#line default
#line hidden
#nullable disable
#nullable restore
#line 30 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.Extensions.Options;

#line default
#line hidden
#nullable disable
#nullable restore
#line 31 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using System.Web;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/checkout")]
    public partial class Checkout : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 301 "O:\Bellvantage\MSL\BlazorServerApp\Pages\Checkout.razor"
       

    private List<CartItem> cartProducts = new List<CartItem>();
    private List<Product> products;
    private List<ListOrderDetail> listOrderDetail;
    private List<Address> ShippingAddress = new List<Address>();
    private string billingAdd { get; set; } = "";
    private Address BillingAddress { get; set; }
    private Address selectedAddress { get; set; }
    private int selectedOutletId;
    private string name = "";
    private string phone = "";
    private string userEmail = "";
    private string address = "";
    private string note = "";
    private string city = "";
    private string province = "";
    private string postalCode = "";
    private string country = "";
    private bool orderStatus = false;
    private int paymentType = 2;
    private int deliveryType = 1;
    private int deliveryOption = 2;
    private string coupon = "";
    private double total;
    private double fullTotal;
    private double discount = 0;
    private int discountStatus;
    private double deliveryFee;
    private double totalWeight = 0;
    private User user;
    private RegisterUser userRegister = new RegisterUser();
    private string response = "";
    private bool agreed { get; set; } = false;
    private bool checkedOut { get; set; } = false;
    private bool validated { get; set; } = false;
    private string paymentLink { get; set; }
    private double abhimanaDiscount = 0;

    private List<Country> countryList { get; set; }
    private List<State> stateList { get; set; }


    protected override void OnInitialized()
    {
        appState.OnChange += StateHasChanged;
        base.OnInitialized();
    }

    public void Dispose()
    {
        appState.OnChange -= StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeAsync<object>("NavBarFixed");
            countryList = new List<Country>();
            countryList = (await apiService.GetCountries()).ToList();
            selectedOutletId = appState.selectedOutletId;
            user = await localStore.GetItemAsync<User>("user");
            SetCart();
            if (user != null)
            {
                var registeruser = Task.Run(async () => await ProfileService.GetCustomer(user.CustomerId));
                userRegister = registeruser.Result;

                if (userRegister != null)
                {
                    name = userRegister.CustomerFirstName + " " + userRegister.CustomerLastName;
                    phone = userRegister.CustomerMobileNo;
                    userEmail = userRegister.CustomerEmailAddress;
                    GetUserAddress(user.CustomerId);
                }

                cartProducts = await localStore.GetItemAsync<List<CartItem>>("cart-" + user.CustomerId);
            }
            else
            {
                cartProducts = await localStore.GetItemAsync<List<CartItem>>("cart-0");
            }

            if (cartProducts != null)
                cartService.SetCart(cartProducts);
            StateHasChanged();
        }
    }

    private void Validate()
    {
        validated = true;
    }

    private async void HandleCheckout()
    {
        listOrderDetail = cartService.GetCheckoutItems();
        if (listOrderDetail.Count() > 0)
        {
            

#line default
#line hidden
#nullable disable
#nullable restore
#line 402 "O:\Bellvantage\MSL\BlazorServerApp\Pages\Checkout.razor"
                   
            var selectedCountry = "";
            var selectedProvince = "";
            if(country != "" && country != String.Empty && country != null)
            {
                selectedCountry = countryList.Where(a => a.CountryCode == country).FirstOrDefault().CountryName;                
            }
            if(province != "" && province != String.Empty && province != null)
            {
                selectedProvince = stateList.Where(a => a.StateCode == province).FirstOrDefault().StateName;               
            }

            string fullAddress = address + ", " + city + ", " + selectedCountry + ", "+ selectedProvince + ", " + postalCode;
            if (billingAdd == null || billingAdd == "")
            {
                billingAdd = address + ", " + city + " ," + selectedCountry + ", " + selectedProvince + ", " + postalCode;
            }
            

#line default
#line hidden
#nullable disable
#nullable restore
#line 422 "O:\Bellvantage\MSL\BlazorServerApp\Pages\Checkout.razor"
               
            if (deliveryType == 2 && (name == String.Empty || name == "" || name == null || phone == String.Empty || phone == "" || phone == null || userEmail == String.Empty || userEmail == "" || userEmail == null ))
            {
                await JSRuntime.InvokeAsync<object>("ErrorAlert", "error", "", "Please fill all the data");
            }
            else if (!phone.All(Char.IsDigit))
            {
                await JSRuntime.InvokeAsync<object>("ErrorAlert", "error", "", "Invalid phone number (Should contain only digits)");
            }
            else if (!agreed)
            {
                await JSRuntime.InvokeAsync<object>("ErrorAlert", "error", "", "Please read and accept the terms and conditions to proceed with your order.");
            }
            else
            {
                checkedOut = true;
                CheckoutCart checkoutCart = cartService.GetCheckout(name, phone, fullAddress, billingAdd, paymentType.ToString(), fullTotal, selectedOutletId, deliveryFee, coupon, discount, deliveryType, deliveryOption);
                await localStore.SetItemAsync("checkout", checkoutCart);
                await localStore.SetItemAsync("userEmail", userEmail);
                await localStore.SetItemAsync("orderType", "normal");
                if (user != null)
                    response = await apiService.Checkout(checkoutCart, user.CustomerId.ToString());
                else
                    response = await apiService.Checkout(checkoutCart, "0");

                var orderId = response.Split(' ')[6];
                orderId = orderId.Remove(orderId.Length - 1);
                await localStore.SetItemAsync("orderId", orderId);

                name = "";
                address = "";
                city = "";
                phone = "";
                userEmail = "";
                postalCode = "";
                orderStatus = true;

                if (paymentType == 2)
                {
                    if(appState.currType == "LKR")
                    { 
                        PaymentSession PaymentResponse = await paymentService.CreateSession(orderId, checkoutCart.TotalAmount, fullAddress);
                        await localStore.SetItemAsync("paymentIndicator", PaymentResponse.successIndicator);

                        await JSRuntime.InvokeAsync<object>("PaymentGateway", PaymentResponse.SessionId.ToString());
                        await JSRuntime.InvokeAsync<object>("Checkout.showPaymentPage");
                        checkedOut = false;
                    }
                    else if(appState.currType == "USD")
                    { 
                        double USDTotal = Math.Round(Convert.ToDouble(checkoutCart.TotalAmount) / appState.currRate.BuyingRate, 2);
                        PaymentSession PaymentResponse = await paymentService.CreateSessionUSD(orderId, USDTotal.ToString(), fullAddress);
                        await localStore.SetItemAsync("paymentIndicator", PaymentResponse.successIndicator);

                        await JSRuntime.InvokeAsync<object>("PaymentGateway", PaymentResponse.SessionId.ToString());
                        await JSRuntime.InvokeAsync<object>("Checkout.showPaymentPage");
                        checkedOut = false;
                    }
                }
                else
                {
                    NavManager.NavigateTo("/paymentSuccess");
                    checkedOut = false;
                }
            }
            

#line default
#line hidden
#nullable disable
#nullable restore
#line 491 "O:\Bellvantage\MSL\BlazorServerApp\Pages\Checkout.razor"
                   
        }
        else
        {
            await JSRuntime.InvokeAsync<object>("ErrorAlert", "error", "", "Cart is empty!");
        }
    }

    private async void AddCoupon()
    {
        if (coupon != null && coupon != "")
        {
            double total = cartService.GetTotal();
            var dis = await apiService.GetDiscount(coupon, total.ToString());
            if (dis == "0.0")
            {
                discountStatus = -1;
                discount = 0;
            }
            else
            {
                discountStatus = 1;
                discount = Convert.ToDouble(dis);
            }
            total = cartService.GetTotal() - discount - abhimanaDiscount;
            fullTotal = total + deliveryFee;
            StateHasChanged();
        }
        else
        {
            await JSRuntime.InvokeAsync<object>("ErrorAlert", "error", "", "Enter Coupon Code!");
        }
    }
    private async void SetCart()
    {
        if (user != null)
        {
            cartProducts = await localStore.GetItemAsync<List<CartItem>>("cart-" + user.CustomerId);
        }
        else
        {
            cartProducts = await localStore.GetItemAsync<List<CartItem>>("cart-0");
        }

        if (cartProducts != null)
        {
            cartService.SetCart(cartProducts);
            appState.SetCartItemCount(cartService.GetTotalCount());
        }
        else
        {
            cartService.EmptyCart();
            appState.SetCartItemCount(0);
        }
        total = cartService.GetTotal();
        fullTotal = total;
        totalWeight = cartService.GetTotalWeight();
        SetDeliveryFee(1);
        StateHasChanged();
    }

    private async void GetUserAddress(int customerId)
    {
        var customershipping = Task.Run(async () => await ProfileService.ShippingAddress(customerId));
        var customerBilling = Task.Run(async () => await ProfileService.BillingAddress(customerId));
        ShippingAddress = customershipping.Result;
        BillingAddress = customerBilling.Result;
        if (ShippingAddress.Count() > 0)
        {
            SetAddress(ShippingAddress[0]);
        }
        if (BillingAddress != null)
        {
            billingAdd = BillingAddress.FullAddress + ", " + BillingAddress.AdCity + ", " + " ," + BillingAddress.Country + "," + BillingAddress.PostalCode;
        }
    }

    private void SetAddress(Address val)
    {
        selectedAddress = val;
        address = val.FullAddress;
        postalCode = val.PostalCode.ToString();
        city = val.AdCity;
        province = val.Province;
        country = val.Country;
        stateList = new List<State>();
        stateList = countryList.Where(a => a.CountryCode == country).FirstOrDefault<Country>().ListState;
        province = val.Province;
        StateHasChanged();
    }

    private async void SetDeliveryFee(int type)
    {
        if (type == 1)
        {
            if (country != string.Empty && country != null)
            {
                //deliveryFee = await apiService.GetDeliveryFeeNormal("1");
                deliveryFee = await apiService.GetDeliveryFee(totalWeight, country, province);
            }
            fullTotal = total + deliveryFee - discount;
        }
        else
        {
            deliveryFee = 0;
            fullTotal = total - discount;
        }
        StateHasChanged();
    }

    private void OnCountryChange()
    {
        stateList = new List<State>();
        province = "";
        deliveryFee = 0;
        fullTotal = total - discount;
        if (country != String.Empty && country != "" && country != null)
        {
            stateList = countryList.Where(a => a.CountryCode == country).FirstOrDefault<Country>().ListState;
        }
    }

    private void OnChangeState()
    {
        SetDeliveryFee(1);
    }

    private void DeliveryTypeSelect(int val)
    {
        deliveryType = val;
        if (deliveryType == 1)
        {
            SetDeliveryFee(1);
            deliveryOption = 2;
        }
        else
        {
            SetDeliveryFee(0);
            deliveryOption = 0;
        }
    }

    private void DeliveryOptionSelect(int val)
    {
        deliveryOption = val;
    }

    private void PaymentSelect(int val)
    {
        paymentType = val;
    }

    public async void ClearCart()
    {
        if (user != null)
        {
            await localStore.RemoveItemAsync("cart-" + user.CustomerId);
        }
        else
        {
            await localStore.RemoveItemAsync("cart-0");
        }
    }


#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IConfiguration Configuration { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private Security security { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IProfileService ProfileService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IPaymentService paymentService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IApiService apiService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager NavManager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AppState appState { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ILocalStorageService localStore { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ICartService cartService { get; set; }
    }
}
#pragma warning restore 1591
