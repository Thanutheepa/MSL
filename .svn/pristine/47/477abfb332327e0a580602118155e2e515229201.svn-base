// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace BlazorServerApp.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using BlazorServerApp;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using BlazorServerApp.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Blazored.LocalStorage;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using BlazorServerApp.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.SearchProductScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.ViewProductScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.CartScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.LoginScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.CoreBusiness.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 19 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using BlazorServerApp.Controls;

#line default
#line hidden
#nullable disable
#nullable restore
#line 21 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Radzen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Radzen.Blazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 23 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.RegisterScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 24 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using ShoppingCart.UseCases.FavProductScreen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 26 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using System.IO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 27 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using System.Configuration;

#line default
#line hidden
#nullable disable
#nullable restore
#line 29 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.Extensions.Configuration;

#line default
#line hidden
#nullable disable
#nullable restore
#line 30 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using Microsoft.Extensions.Options;

#line default
#line hidden
#nullable disable
#nullable restore
#line 31 "O:\Bellvantage\MSL\BlazorServerApp\_Imports.razor"
using System.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "O:\Bellvantage\MSL\BlazorServerApp\Pages\OTPRegister.razor"
using System.Text.RegularExpressions;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/otp_register")]
    public partial class OTPRegister : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 153 "O:\Bellvantage\MSL\BlazorServerApp\Pages\OTPRegister.razor"
       

    private int id;
    private User user = new User();
    private List<User> saveUser = new List<User> { };
    private string otpcode;
    private bool result;
    private string success = "false";
    private string loginsave;
    private int otp;
    private bool submitOTP = true;
    private bool ChangePhone = false;
    private string MobileNumber = "";
    private string changemobileError = "";
    private int updateResult;
    private int noofTimesMobileChanged = 0;
    private int noofTimeResend = 1;
    private string attemptCountError = "";
    private RegisterUser registerUser = new RegisterUser();

    TimeSpan TimeLeft = new TimeSpan(0, 0, 60);
    string displaytext = "";

    protected override async void OnInitialized()
    {
        base.OnInitialized();
        Timer();

    }

    protected void timerRender()
    {
        Timer();
    }

    async Task Timer()
    {
        while (TimeLeft > new TimeSpan())
        {
            await Task.Delay(1000);
            TimeLeft = TimeLeft.Subtract(new TimeSpan(0, 0, 1));
            StateHasChanged();
        }
        await AfterTime();
        StateHasChanged();
    }

    Task AfterTime()
    {
        displaytext = "OTP code is expired.";
        submitOTP = false;
        return Task.CompletedTask;
    }



    protected void HandleOTP()

    {

        success = "false";

        if (otpcode == null || otpcode == string.Empty)
        {
            success = "Please enter the OTP code";
        }


        else
        {



            if (OTPValidate() == false)
            {
                success = "OTP code Should contain 6 digits";
                otpcode = "";
            }

            else if (success == "false")
            {

                user = login.GetUsers();


                id = user.CustomerId;


                otp = Convert.ToInt32(otpcode);

                if(noofTimesMobileChanged == 0)
                {
                    var verifiedCostomer = Task.Run(async () => await RegisterService.VerifedOtp(id, otp));
                    result = verifiedCostomer.Result;


                    if (result == true)
                    {
                        saveUser.Add(user);

                        var savelogin = Task.Run(async () => await RegisterService.SaveLogin(saveUser));
                        loginsave = savelogin.Result;

                        if (loginsave.ToLower() == "successfully inserted")
                        {
                            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Successfuly", Detail = "Verified", Duration = 1000 });
                            NavManager.NavigateTo("/login");
                        }
                        else
                        {
                            success = loginsave;
                        }
                    }

                    else
                    {
                        otpcode = "";
                        success = "Invalid Verifcation Code";
                        ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Invalid", Detail = "Verification Code", Duration = 1000 });
                    }
                }
                else
                {
                    var verifiedcustomer = Task.Run(async () => await RegisterService.VerifyOTPforUpdateCustomer(id, otp));
                    string resultcustomer = verifiedcustomer.Result;


                    if (resultcustomer == "true")
                    {
                        saveUser.Add(user);

                        var savelogin = Task.Run(async () => await RegisterService.SaveLogin(saveUser));
                        loginsave = savelogin.Result;

                        if (loginsave.ToLower() == "successfully inserted")
                        {
                            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Successfuly", Detail = "Verified", Duration = 1000 });
                            NavManager.NavigateTo("/login");
                        }
                        else
                        {
                            success = loginsave;
                        }
                    }

                    else
                    {
                        otpcode = "";
                        success = "Invalid Verifcation Code";
                        ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Invalid", Detail = "Verification Code", Duration = 1000 });
                    }
                }
            }

        }
    }

    protected void HandleResendOTP()
    {
        user = login.GetUsers();
        id = user.CustomerId;


        var verifiedCostomer = Task.Run(async () => await RegisterService.ResendOtp(id));
        result = verifiedCostomer.Result;

        if (result == true)
        {
            submitOTP = true;
            noofTimeResend = noofTimeResend + 1;

            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Successfully", Detail = "Resend the OTP code", Duration = 1000 });
        }

        else
        {
           // submitOTP = false;
            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Something Wrong. ", Detail = "Plese Resend the OTP code", Duration = 1000 });
        }

        if (noofTimeResend == 5)
        {
            attemptCountError = "Maximum no of attempt is over.";
            TimeLeft = new TimeSpan(0, 0, 60);
            displaytext = "";
            timerRender();
        }
        else
        {
            
            TimeLeft = new TimeSpan(0, 0, 60);
            displaytext = "";
            timerRender();
        }

    }


    private async void HandleChangeMobile()
    {
        user = login.GetUsers();
        id = user.CustomerId;

        changemobileError = "";
        if (MobileNumber == string.Empty || MobileNumber == null)
        {
            changemobileError = "Please enter mobile number";
        }

        else
        {
            if (PhoneValidate() == false)
            {
                changemobileError = "Invalid mobile number";
                MobileNumber = "";
            }

            else
            {
                registerUser = register.GetUser();

                if (registerUser.CustomerMobileNo == MobileNumber)
                {
                    changemobileError = "This mobile number is same as previous. Please Enter another mobile number.";
                    MobileNumber = "";
                }

                else
                {
                    registerUser.CustomerId = id;
                    registerUser.CustomerMobileNo = MobileNumber;

                    var updateregisterCostomer = Task.Run(async () => await RegisterService.UpdateCustomer(registerUser));
                    updateResult = updateregisterCostomer.Result;

                    if (updateResult == 1)
                    {
                        noofTimesMobileChanged = noofTimesMobileChanged + 1;
                        await JSRuntime.InvokeAsync<object>("ErrorAlert", "success", "", "mobile number is updated successfully!");
                        ChangePhone = false;
                        noofTimeResend = 1;
                        TimeLeft = new TimeSpan(0, 0, 120);
                        displaytext = "";
                        submitOTP = true;
                        success = "false";
                        timerRender();
                        StateHasChanged();
                    }

                    else
                    {
                        await JSRuntime.InvokeAsync<object>("ErrorAlert", "error", "", "Something Wrong! Please Try again");

                    }
                }

            }
        }
    }

    private void HandleCancel()
    {
        ChangePhone = false;
    }

    private void ChangeMobile()
    {
        ChangePhone = true;
    }

    void ShowNotification(NotificationMessage message)
    {
        NotificationService.Notify(message);
    }

    private bool OTPValidate()
    {
        Regex otpreg = new Regex("^[1-9]{1}[0-9]{2}[0-9]{3}$");
        if (otpreg.IsMatch(otpcode))
        {
            return true;
        }
        else
        {
            return false;
        }
    }

    private bool PhoneValidate()
    {
        Regex phone = new Regex("[0-9]{10}");
        if (phone.IsMatch(MobileNumber))
        {
            return true;
        }
        else
        {
            return false;
        }
    }


#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IRegister register { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IRegisterService RegisterService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ILogin login { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager NavManager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NotificationService NotificationService { get; set; }
    }
}
#pragma warning restore 1591
